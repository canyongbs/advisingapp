#!/command/with-contenv bash

# Exit on error
set -e

if [ ! -f "$WEBUSER_HOME/artisan" ]; then
  echo "Skipping permissions fix because we could not detect a Laravel install..."
  exit 1
fi

if [ "${FIX_PERMISSIONS:="false"}" == "true" ]; then
  echo "Fixing ownership and permissions..."

  # Single find operation with combined actions for better performance on WSL/macOS
  find /var/www/html \
    \( -path /var/www/html/.git -o -path /var/www/html/public/storage \) -prune -o \
    \( -type d -exec chown "$PUID":"$PGID" {} + -exec chmod 755 {} + \) -o \
    \( -type f ! -path '*/docker/*' ! -path '*/node_modules/*' ! -path '*/vendor/*' \
       -exec chown "$PUID":"$PGID" {} + -exec chmod 644 {} + \)

  chmod -R ug+rwx /var/www/html/storage /var/www/html/bootstrap/cache

  if [ -e /var/www/html/rr ]; then
    chmod 0755 /var/www/html/rr
  fi

  chmod +x /var/www/html/pls

  echo "Ownership and permissions fixed!"
else
    echo "Skipping permissions fix because it was specifically disabled..."
fi

exit 0
